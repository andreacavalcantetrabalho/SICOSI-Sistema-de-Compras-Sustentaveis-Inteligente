/**
 * Content Script - SICOSI (VERS√ÉO CORRIGIDA COMPLETA)
 * ARQUIVO: scripts/content-script.js
 * Combina a simplicidade da vers√£o antiga com as melhorias da nova
 * Prioriza funcionamento b√°sico sobre funcionalidades avan√ßadas
 */

(function() {
  'use strict';

  // Prevenir m√∫ltiplas execu√ß√µes
  if (window.SICOSISustentavelInitialized) {
    return;
  }
  window.SICOSISustentavelInitialized = true;

  // Vari√°veis globais
  let currentModal = null;
  let isModalVisible = false;
  let debounceTimer = null;
  let observerInstance = null;
  let userSettings = { enabled: true }; // Padr√£o simples
  let llmAnalyzer = null;

  console.log("üå± SICOSI: Iniciando extens√£o...");

  /**
   * INICIALIZA√á√ÉO SIMPLIFICADA E ROBUSTA
   */
  async function initialize() {
    try {
      // Verificar compatibilidade da p√°gina
      if (!isCompatiblePage()) {
        console.log("üå± SICOSI: P√°gina n√£o compat√≠vel");
        return;
      }

      // Carregar configura√ß√µes (com fallback)
      await loadUserSettings();

      if (!userSettings.enabled) {
        console.log("üå± SICOSI: Extens√£o desabilitada");
        return;
      }

      // Inicializar LLM se dispon√≠vel (n√£o bloquear se falhar)
      await initializeLLMAnalyzer();

      // Configurar monitoramento
      setupPageObserver();
      monitorExistingElements();

      console.log("üå± SICOSI: Extens√£o ativa e funcionando!");

    } catch (error) {
      console.error("üå± SICOSI: Erro na inicializa√ß√£o:", error);
      // Continuar funcionando mesmo com erro
      setupBasicMonitoring();
    }
  }

  /**
   * VERIFICA√á√ÉO DE COMPATIBILIDADE SIMPLES
   */
  function isCompatiblePage() {
    const hostname = window.location.hostname;
    return hostname.includes('compras.gov.br') || 
           hostname === 'localhost' || 
           hostname === '127.0.0.1';
  }

  /**
   * CARREGAMENTO DE CONFIGURA√á√ïES COM FALLBACK
   */
  async function loadUserSettings() {
    try {
      if (chrome?.storage?.sync) {
        const result = await chrome.storage.sync.get(['SICOSISettings']);
        userSettings = result.SICOSISettings || { enabled: true };
      }
    } catch (error) {
      console.warn("üå± SICOSI: Usando configura√ß√µes padr√£o");
      userSettings = { enabled: true };
    }
  }

  /**
   * INICIALIZA√á√ÉO DO LLM (N√ÉO BLOQUEAR SE FALHAR)
   */
  async function initializeLLMAnalyzer() {
    try {
      if (window.SICOSILLMAnalyzer) {
        llmAnalyzer = window.SICOSILLMAnalyzer;
        await llmAnalyzer.initialize();
        console.log("üå± SICOSI: LLM analyzer dispon√≠vel");
      }
    } catch (error) {
      console.warn("üå± SICOSI: LLM n√£o dispon√≠vel, usando an√°lise local");
      llmAnalyzer = null;
    }
  }

  /**
   * OBSERVADOR DE DOM ROBUSTO
   */
  function setupPageObserver() {
    if (observerInstance) {
      observerInstance.disconnect();
    }

    observerInstance = new MutationObserver(() => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(monitorExistingElements, 500);
    });

    observerInstance.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: false // Reduzir carga
    });

    // Backup: verifica√ß√£o peri√≥dica
    setInterval(monitorExistingElements, 3000);
  }

  /**
   * MONITORAMENTO B√ÅSICO COMO FALLBACK
   */
  function setupBasicMonitoring() {
    console.log("üå± SICOSI: Usando monitoramento b√°sico de fallback");
    setInterval(monitorExistingElements, 2000);
  }

  /**
   * DETEC√á√ÉO DE BOT√ïES ROBUSTA E SIMPLES
   */
  function monitorExistingElements() {
    if (!userSettings?.enabled) return;

    // Buscar TODOS os bot√µes da p√°gina
    const allButtons = document.querySelectorAll('button, input[type="button"], input[type="submit"], a.btn');
    
    allButtons.forEach(button => {
      if (button.hasSICOSIListener) return;

      const buttonText = (button.textContent || button.value || button.title || '').toLowerCase().trim();
      
      // Termos que indicam a√ß√£o de adicionar item
      const actionTerms = [
        'selecionar', 'adicionar', 'incluir', 'comprar', 
        'solicitar', 'escolher', 'confirmar'
      ];

      const isActionButton = actionTerms.some(term => buttonText.includes(term));

      if (isActionButton) {
        console.log(`‚úÖ SICOSI: Adicionando listener ao bot√£o: "${buttonText}"`);
        button.hasSICOSIListener = true;
        
        // Usar capture phase para interceptar antes
        button.addEventListener('click', handleButtonClick, true);
        
        // Debug visual (remov√≠vel em produ√ß√£o)
        if (userSettings.debug) {
          button.style.outline = '2px solid green';
          button.title = `SICOSI monitora: ${buttonText}`;
        }
      }
    });
  }

  /**
   * HANDLER DE CLIQUE PRINCIPAL
   */
  async function handleButtonClick(event) {
    if (isModalVisible) {
      console.log("‚ö†Ô∏è SICOSI: Modal j√° vis√≠vel, ignorando");
      return;
    }

    console.log("üéØ SICOSI: Bot√£o clicado:", event.target);

    const button = event.currentTarget || event.target;
    const productInfo = extractProductInfo(button);

    if (!productInfo.description) {
      console.warn("‚ö†Ô∏è SICOSI: N√£o conseguiu extrair descri√ß√£o do produto");
      return; // Permitir a√ß√£o normal
    }

    console.log("üì¶ SICOSI: Produto detectado:", productInfo.description);

    try {
      const analysis = await analyzeProduct(productInfo);
      
      if (analysis && !analysis.isSustainable && analysis.alternatives?.length > 0) {
        console.log("üå± SICOSI: Produto n√£o sustent√°vel - mostrando modal");
        
        // INTERCEPTAR A A√á√ÉO
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();

        await showSustainabilityModal(productInfo, analysis, () => {
          // Callback para continuar com a√ß√£o original
          console.log("‚úÖ SICOSI: Usu√°rio optou por continuar");
          button.removeEventListener('click', handleButtonClick, true);
          setTimeout(() => button.click(), 100);
        });

        // Log analytics se dispon√≠vel
        logEvent('modal_shown', productInfo.description);
      }

    } catch (error) {
      console.error("‚ùå SICOSI: Erro na an√°lise:", error);
      // Permitir a√ß√£o normal em caso de erro
    }
  }

  /**
   * EXTRA√á√ÉO DE INFORMA√á√ïES DO PRODUTO ROBUSTA
   */
  function extractProductInfo(button) {
    const info = {
      description: '',
      material: '',
      fullText: '',
      code: ''
    };

    // Estrat√©gia 1: Procurar na linha da tabela (mais comum)
    let container = button.closest('tr') || 
                   button.closest('.item-row') || 
                   button.closest('li') ||
                   button.parentElement?.parentElement;

    if (container) {
      // Extrair de c√©lulas da tabela
      const cells = container.querySelectorAll('td, th');
      
      if (cells.length >= 2) {
        info.code = extractCleanText(cells[0]);
        info.description = extractCleanText(cells[1]);
        
        // Procurar material em c√©lulas adicionais
        for (let i = 2; i < cells.length; i++) {
          const cellText = extractCleanText(cells[i]).toLowerCase();
          if (cellText.includes('material:') || cellText.length > 10) {
            info.material = cellText.replace(/^material:\s*/i, '');
            break;
          }
        }
      } else {
        // Fallback: extrair todo texto do container
        info.description = extractCleanText(container);
      }
    }

    // Estrat√©gia 2: Procurar em elementos pr√≥ximos
    if (!info.description) {
      const nearby = button.parentElement;
      if (nearby) {
        const textElements = nearby.querySelectorAll('span, div, p, td');
        textElements.forEach(el => {
          const text = extractCleanText(el);
          if (text.length > info.description.length && text.length > 10) {
            info.description = text;
          }
        });
      }
    }

    info.fullText = `${info.code} ${info.description} ${info.material}`.toLowerCase();
    
    return info;
  }

  /**
   * EXTRA√á√ÉO DE TEXTO LIMPO
   */
  function extractCleanText(element) {
    if (!element) return '';
    const text = element.textContent || element.innerText || '';
    return text.replace(/\s+/g, ' ').trim();
  }

  /**
   * AN√ÅLISE DE PRODUTO (LLM + FALLBACK)
   */
  async function analyzeProduct(productInfo) {
    // Tentar LLM primeiro
    if (llmAnalyzer) {
      try {
        const llmResult = await llmAnalyzer.analyzeProduct(productInfo);
        if (llmResult) {
          console.log("ü§ñ SICOSI: An√°lise LLM bem-sucedida");
          return llmResult;
        }
      } catch (error) {
        console.warn("ü§ñ SICOSI: LLM falhou, usando an√°lise local:", error);
      }
    }

    // Fallback para an√°lise local
    return analyzeProductLocally(productInfo);
  }

  /**
   * AN√ÅLISE LOCAL ROBUSTA
   */
  function analyzeProductLocally(productInfo) {
    const text = productInfo.fullText;
    
    // Termos sustent√°veis
    const sustainableTerms = [
      'biodegrad√°vel', 'biodegradavel', 'compost√°vel', 'compostavel',
      'reciclado', 'recicl√°vel', 'reciclavel', 'fsc', 'certificado',
      'sustent√°vel', 'sustentavel', 'ecol√≥gico', 'ecologico',
      'bambu', 'baga√ßo', 'bagaco', 'natural', 'org√¢nico', 'organico'
    ];

    // Termos n√£o sustent√°veis
    const unsustainableTerms = [
      'pl√°stico comum', 'plastico comum', 'descart√°vel comum',
      'poliestireno', 'isopor', 'pvc'
    ];

    const hasSustainable = sustainableTerms.some(term => text.includes(term));
    const hasUnsustainable = unsustainableTerms.some(term => text.includes(term));
    
    const isSustainable = hasSustainable || !hasUnsustainable;
    
    // Gerar alternativas se n√£o sustent√°vel
    const alternatives = isSustainable ? [] : generateLocalAlternatives(productInfo.description);

    return {
      isSustainable,
      sustainabilityScore: isSustainable ? 7 : 3,
      reason: isSustainable ? 
        'Produto apresenta caracter√≠sticas sustent√°veis' : 
        'Produto convencional - considere alternativas ecol√≥gicas',
      alternatives,
      needsAlternatives: !isSustainable && alternatives.length > 0,
      analysisMethod: 'local'
    };
  }

  /**
   * GERA√á√ÉO DE ALTERNATIVAS LOCAIS
   */
  function generateLocalAlternatives(description) {
    const desc = description.toLowerCase();
    const alternatives = [];

    if (desc.includes('copo') && (desc.includes('pl√°stico') || desc.includes('descart√°vel'))) {
      alternatives.push({
        name: 'Copo biodegrad√°vel de baga√ßo de cana',
        description: 'Produzido com res√≠duo agr√≠cola, decomp√µe em 90 dias',
        benefits: 'Zero pl√°stico, compost√°vel, renov√°vel',
        searchTerms: ['copo biodegrad√°vel', 'copo baga√ßo cana']
      });
      alternatives.push({
        name: 'Copo de papel certificado FSC',
        description: 'Papel de fonte respons√°vel com certifica√ß√£o florestal',
        benefits: 'Recicl√°vel, manejo sustent√°vel',
        searchTerms: ['copo papel FSC', 'copo certificado']
      });
    }

    if (desc.includes('papel') && !desc.includes('reciclado')) {
      alternatives.push({
        name: 'Papel A4 100% reciclado',
        description: 'Papel de alta qualidade produzido com aparas p√≥s-consumo',
        benefits: 'Preserva √°rvores, economiza √°gua e energia',
        searchTerms: ['papel A4 reciclado', 'papel ecol√≥gico']
      });
    }

    if (desc.includes('detergente') && !desc.includes('biodegrad√°vel')) {
      alternatives.push({
        name: 'Detergente biodegrad√°vel concentrado',
        description: 'F√≥rmula concentrada com surfactantes vegetais',
        benefits: 'N√£o polui √°guas, biodegrada rapidamente',
        searchTerms: ['detergente biodegrad√°vel', 'detergente ecol√≥gico']
      });
    }

    return alternatives.slice(0, 3); // Limitar a 3 alternativas
  }

  /**
   * MODAL DE SUSTENTABILIDADE
   */
  async function showSustainabilityModal(productInfo, analysis, continueCallback) {
    if (isModalVisible) return;

    isModalVisible = true;
    currentModal = createModal(productInfo, analysis, continueCallback);
    document.body.appendChild(currentModal);

    // Animar entrada
    setTimeout(() => {
      if (currentModal) {
        currentModal.classList.add('sicosi-modal-visible');
      }
    }, 50);

    // Auto-fechar ap√≥s 20 segundos
    setTimeout(() => {
      if (currentModal) {
        closeModal();
        if (continueCallback) continueCallback();
      }
    }, 20000);
  }

  /**
   * CRIA√á√ÉO DO MODAL
   */
  function createModal(productInfo, analysis, continueCallback) {
    const modal = document.createElement('div');
    modal.id = 'sicosi-modal';
    modal.className = 'sicosi-modal-overlay';

    const alternativesHTML = analysis.alternatives
      .map(alt => `
        <div class="sicosi-alternative-item">
          <h4>${alt.name}</h4>
          <p>${alt.description}</p>
          <p class="sicosi-benefits">‚úÖ ${alt.benefits}</p>
          <div class="sicosi-search-actions">
            ${alt.searchTerms.map(term => `
              <button class="sicosi-search-btn" data-search="${term}">
                üîç Buscar: ${term}
              </button>
            `).join('')}
          </div>
        </div>
      `).join('');

    modal.innerHTML = `
      <div class="sicosi-modal-content">
        <div class="sicosi-modal-header">
          <div class="sicosi-header-info">
            <span class="sicosi-icon">üå±</span>
            <div>
              <h3>Alternativa Sustent√°vel Encontrada</h3>
              <p>Sistema Inteligente de Compras Sustent√°veis</p>
            </div>
          </div>
          <button class="sicosi-close-btn">&times;</button>
        </div>
        
        <div class="sicosi-modal-body">
          <div class="sicosi-product-info">
            <h4>Produto selecionado:</h4>
            <p><strong>${productInfo.description}</strong></p>
            <p class="sicosi-analysis">An√°lise: ${analysis.reason}</p>
          </div>
          
          <div class="sicosi-alternatives">
            <h4>üåø Alternativas sustent√°veis recomendadas:</h4>
            ${alternativesHTML}
          </div>
          
          <div class="sicosi-actions">
            <button class="sicosi-btn-continue" id="continueOriginal">
              Continuar com produto original
            </button>
          </div>
          
          <div class="sicosi-footer">
            <small>üí° An√°lise: ${analysis.analysisMethod === 'llm' ? 'ü§ñ IA' : 'üìä Local'} | 
            ${new Date().toLocaleTimeString('pt-BR')}</small>
          </div>
        </div>
      </div>
    `;

    setupModalEvents(modal, continueCallback);
    return modal;
  }

  /**
   * EVENTOS DO MODAL
   */
  function setupModalEvents(modal, continueCallback) {
    // Fechar modal
    const closeBtn = modal.querySelector('.sicosi-close-btn');
    const continueBtn = modal.querySelector('#continueOriginal');

    closeBtn?.addEventListener('click', () => {
      closeModal();
      logEvent('modal_dismissed', 'close_button');
    });

    continueBtn?.addEventListener('click', () => {
      closeModal();
      if (continueCallback) continueCallback();
      logEvent('modal_action', 'continue_original');
    });

    // Bot√µes de busca
    modal.querySelectorAll('.sicosi-search-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const searchTerm = btn.dataset.search;
        performSearch(searchTerm);
        closeModal();
        logEvent('alternative_search', searchTerm);
      });
    });

    // Fechar ao clicar fora
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
        logEvent('modal_dismissed', 'backdrop_click');
      }
    });
  }

  /**
   * BUSCAR ALTERNATIVA
   */
  function performSearch(searchTerm) {
    const searchInput = document.querySelector('input[type="text"], input[type="search"]');
    
    if (searchInput) {
      searchInput.value = searchTerm;
      searchInput.focus();
      
      // Disparar eventos
      ['input', 'change'].forEach(eventType => {
        searchInput.dispatchEvent(new Event(eventType, { bubbles: true }));
      });
      
      // Tentar submit
      const form = searchInput.closest('form');
      if (form) {
        form.submit();
      } else {
        searchInput.dispatchEvent(new KeyboardEvent('keydown', {
          key: 'Enter',
          keyCode: 13,
          bubbles: true
        }));
      }
      
      console.log("üîç SICOSI: Buscando por:", searchTerm);
    }
  }

  /**
   * FECHAR MODAL
   */
  function closeModal() {
    if (currentModal) {
      currentModal.classList.add('sicosi-modal-closing');
      setTimeout(() => {
        if (currentModal?.parentNode) {
          currentModal.parentNode.removeChild(currentModal);
        }
        currentModal = null;
        isModalVisible = false;
      }, 300);
    }
  }

  /**
   * LOG DE EVENTOS
   */
  function logEvent(event, details) {
    try {
      if (window.SICOSIStorage?.logAnalytics) {
        window.SICOSIStorage.logAnalytics(event, details);
      }
      console.log(`üìä SICOSI: ${event} - ${details}`);
    } catch (error) {
      console.warn("üìä SICOSI: Erro no log:", error);
    }
  }

  // CSS do Modal (inline para garantir que funcione)
  const modalCSS = `
    .sicosi-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 999999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sicosi-modal-overlay.sicosi-modal-visible {
      opacity: 1;
      visibility: visible;
    }

    .sicosi-modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 650px;
      max-height: 85vh;
      width: 90%;
      overflow: hidden;
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }

    .sicosi-modal-visible .sicosi-modal-content {
      transform: scale(1);
    }

    .sicosi-modal-header {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sicosi-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sicosi-icon {
      font-size: 28px;
    }

    .sicosi-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .sicosi-modal-header p {
      margin: 2px 0 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .sicosi-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }

    .sicosi-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .sicosi-modal-body {
      padding: 24px;
      max-height: calc(85vh - 140px);
      overflow-y: auto;
    }

    .sicosi-product-info {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #ff9800;
    }

    .sicosi-product-info h4 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 14px;
    }

    .sicosi-product-info p {
      margin: 4px 0;
      font-size: 13px;
      color: #555;
    }

    .sicosi-analysis {
      font-style: italic;
      color: #666 !important;
    }

    .sicosi-alternatives h4 {
      margin: 20px 0 16px 0;
      color: #333;
      font-size: 16px;
    }

    .sicosi-alternative-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      background: #fafafa;
      transition: all 0.2s;
    }

    .sicosi-alternative-item:hover {
      border-color: #4CAF50;
      background: #f8fff8;
    }

    .sicosi-alternative-item h4 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 15px;
    }

    .sicosi-alternative-item p {
      margin: 6px 0;
      font-size: 13px;
      color: #666;
    }

    .sicosi-benefits {
      color: #4CAF50 !important;
      font-weight: 500;
    }

    .sicosi-search-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .sicosi-search-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .sicosi-search-btn:hover {
      background: #45a049;
    }

    .sicosi-actions {
      text-align: center;
      margin: 24px 0 16px 0;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
    }

    .sicosi-btn-continue {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sicosi-btn-continue:hover {
      background: #e8e8e8;
      color: #333;
    }

    .sicosi-footer {
      text-align: center;
      font-size: 11px;
      color: #888;
      margin-top: 16px;
    }

    .sicosi-modal-closing {
      opacity: 0;
      visibility: hidden;
    }

    /* Responsivo */
    @media (max-width: 768px) {
      .sicosi-modal-content {
        width: 95%;
        margin: 0 8px;
      }
      
      .sicosi-modal-header {
        padding: 20px 16px;
      }
      
      .sicosi-modal-body {
        padding: 20px 16px;
      }
      
      .sicosi-search-actions {
        flex-direction: column;
      }
      
      .sicosi-search-btn {
        width: 100%;
      }
    }
  `;

  // Injetar CSS
  const style = document.createElement('style');
  style.textContent = modalCSS;
  document.head.appendChild(style);

  // INICIALIZAR
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }

  // Cleanup
  window.addEventListener('beforeunload', () => {
    if (observerInstance) {
      observerInstance.disconnect();
    }
    if (currentModal) {
      closeModal();
    }
  });

  // Debug dispon√≠vel no console
  window.SICOSI_DEBUG = {
    isModalVisible: () => isModalVisible,
    userSettings: () => userSettings,
    testModal: () => showSustainabilityModal(
      { description: 'copo descart√°vel pl√°stico' },
      {
        isSustainable: false,
        reason: 'Produto teste n√£o sustent√°vel',
        alternatives: [{
          name: 'Copo teste biodegrad√°vel',
          description: 'Alternativa de teste',
          benefits: 'Teste sustent√°vel',
          searchTerms: ['copo teste']
        }]
      }
    ),
    forceMonitor: monitorExistingElements
  };

  console.log("üå± SICOSI: Script carregado e pronto para uso!");

})();